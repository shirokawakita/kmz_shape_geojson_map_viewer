# KMZ, Shape and GeoJSON Map Viewer and Drawer 🗺️

国土地理院地図をベースにKMZファイル、Shapeファイル（ZIP形式）、GeoJSONファイルを重畳表示し、ポリゴンの描画も可能なWebアプリケーションです。

## 機能

### 📍 対応ファイル形式
- **KMZファイル**: Google Earth形式の地理データファイル
- **Shapeファイル**: ESRI Shape形式（ZIP圧縮されたもの）
- **GeoJSONファイル**: GeoJSON形式の地理データファイル（.geojson/.json）

### ✏️ ポリゴン描画機能
- **地図上での直接描画**: クリックしてポリゴンを描画
- **編集・削除**: 描画したポリゴンの編集と削除が可能
- **GeoJSONエクスポート**: 描画したポリゴンをGeoJSONファイルとして保存

### 🗺️ 背景地図
国土地理院が提供する以下の地図タイルを利用できます：
- **標準地図**: 一般的な地形図
- **淡色地図**: 背景がシンプルな地図
- **航空写真**: 衛星・航空写真

### 🎨 表示機能
- **KMZデータ**: 赤色の線のみで表示（透明度30%、塗りつぶしなし）
- **Shapeデータ**: 濃い青色の縁 + 薄い水色の塗りつぶし（透過率60%）
- **GeoJSONデータ**: 濃い赤色の縁 + 薄い赤色の塗りつぶし（透過率60%）

#### 📊 データ形式別の視覚的区別
| データ形式 | 縁線の色 | 塗りつぶし色 | 透過率 | 識別ポイント |
|------------|----------|--------------|--------|--------------|
| KMZ | 赤色 | なし | 線: 70% | 線のみの表示 |
| Shape | 濃い青色 (#001a33) | 薄い水色 (#B0E0E6) | 60% | 青色系の配色 |
| GeoJSON | 濃い赤色 (#8B0000) | 薄い赤色 (#FFA07A) | 60% | 赤色系の配色 |
| 描画ポリゴン | 紫色 (#97009c) | ピンク (#ff69b4) | 30% | 紫・ピンク系の配色 |

#### 🔧 機能詳細
- **ポップアップ**: 地物をクリックすると属性情報を表示
- **自動ズーム**: データ読み込み後、適切な縮尺に自動調整
- **レイヤー制御**: 各レイヤーの表示/非表示を個別に切り替え可能
- **個別ポリゴン制御**: Shape/GeoJSON/描画ファイル内の各ポリゴンを個別に表示/非表示切り替え
- **重複除去**: 同じ地理的エリアを表す重複ポリゴンを自動的に除去
- **属性名自動取得**: ポリゴン名を属性データから自動検出
- **ポリゴン描画**: 地図上でインタラクティブにポリゴンを作成
- **描画編集**: 描画したポリゴンの頂点移動、削除が可能
- **GeoJSONエクスポート**: 描画したポリゴンをファイルとして保存

## 使用方法

### 1. アプリケーションの起動
```bash
# Webブラウザでindex.htmlを開く
# 例: Chrome, Firefox, Safari等で開く
```

### 2. ファイルの読み込み
1. **KMZファイル読み込み**:
   - 「KMZファイル」ボタンをクリック
   - KMZファイル（例：`sample_data.kmz`）を選択
   - 読み込み後は**赤色の線**で表示されます

2. **Shapeファイル読み込み**:
   - 「Shapeファイル (ZIP)」ボタンをクリック
   - ZIPファイル（例：`sample_data.zip`）を選択
   - 読み込み後は**青色系**で表示されます

3. **GeoJSONファイル読み込み**:
   - 「GeoJSONファイル」ボタンをクリック
   - `.geojson`または`.json`拡張子のファイルを選択
   - 読み込み後は**赤色系**で表示されます

4. **ポリゴン描画**:
   - 地図左上の描画ツールでポリゴンボタンをクリック
   - 地図上をクリックしてポリゴンの頂点を設定
   - 最初の点をクリックするかダブルクリックで描画完了
   - 描画後は**紫・ピンク系**で表示されます

5. **GeoJSONエクスポート**:
   - 「描画ポリゴンをGeoJSONで保存」ボタンをクリック
   - 描画したポリゴンがGeoJSONファイルとしてダウンロードされます
   - ファイル名は自動的に日時が付与されます

### 3. 地図操作
- **ズーム**: マウスホイールまたは地図上の+/-ボタン
- **パン**: 地図をドラッグして移動
- **背景地図切り替え**: 右上のコントロールパネルで選択
- **属性情報**: 地物をクリックしてポップアップを表示

### 4. レイヤー管理
- **クリア**: 「レイヤーをクリア」ボタンで全てのデータを削除
- **重畳表示**: 複数のファイルを同時に表示可能
- **表示制御**: 右上のコントロールパネルでレイヤーの表示/非表示を切り替え
  - KMZレイヤー: チェックボックスで表示制御
  - Shapeレイヤー（全体）: 全ポリゴンの一括表示制御
    - チェックを外すと全ポリゴンが非表示に
    - チェックを入れると全ポリゴンが表示
  - GeoJSONレイヤー（全体）: 全ポリゴンの一括表示制御
    - Shapeレイヤーと同様の操作
  - 描画ポリゴン（全体）: 描画した全ポリゴンの一括表示制御
    - 描画機能で作成したポリゴンを制御
  - 個別ポリゴン: Shape/GeoJSON/描画ファイル内の各ポリゴンを個別に制御
    - ポリゴン名は属性データから自動取得
    - 属性がない場合は「ポリゴン 1」「ポリゴン 2」と番号付け
    - 描画ポリゴンは「描画ポリゴン 1」「描画ポリゴン 2」と自動命名
    - 個別チェックボックスの状態に応じて全体チェックボックスも自動更新

## 技術仕様

### 使用ライブラリ
- **Leaflet.js 1.9.4**: インタラクティブ地図表示
- **Leaflet.draw 1.0.4**: ポリゴン描画・編集機能
- **JSZip 3.10.1**: ZIP/KMZファイルの展開
- **Shapefile.js 0.6.6**: Shapeファイルの読み込み
- **toGeoJSON 0.16.0**: KML/KMZからGeoJSONへの変換

### 地図タイル
- **提供元**: 国土地理院
- **ライセンス**: 国土地理院コンテンツ利用規約に準拠
- **最大ズームレベル**: 18

### ブラウザ対応
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

### スタイル仕様
- **レンダリング**: Leaflet.js による高性能地図描画
- **色分け**: データ形式別の自動色分け機能
- **透過率**: 背景地図との視認性を考慮した最適化
- **重複処理**: 高精度なバウンディングボックス比較アルゴリズム

## ファイル構成

```
satellite_observation_mapper/
├── index.html                                    # メインアプリケーション
├── README.md                                     # プロジェクト概要とクイックスタートガイド
├── CHANGELOG.md                                  # バージョン管理と変更履歴
├── sample_data.kmz                               # サンプルKMZファイル
├── sample_data.zip                               # サンプルShapeファイル
└── *.geojson / *.json                            # GeoJSONファイル（ユーザー提供）
```

## 利用上の注意

### データ制限
- ファイルサイズ: 推奨100MB以下
- 複雑なポリゴン: パフォーマンスに影響する場合があります
- 重複ポリゴン: 同じ地理的エリアを表すポリゴンは自動的に除去されます

### 表示・色分けについて
- **データ形式の識別**: KMZ（赤線）、Shape（青系）、GeoJSON（赤系）で自動色分け
- **視認性**: 60%透過率により背景地図との調和を実現
- **個別制御**: 各ポリゴンを個別に表示/非表示可能
- **属性表示**: クリック時のポップアップで詳細情報を確認可能

### セキュリティ
- 全ての処理はクライアントサイドで実行
- ファイルデータはブラウザ内でのみ処理され、外部に送信されません

### エラー対処
1. **ファイル読み込みエラー**: ファイル形式を確認してください
2. **表示されない**: コンソール（F12）でエラーメッセージを確認
3. **パフォーマンス低下**: 大きなファイルの場合、ブラウザを再起動

## ライセンス

このアプリケーションは教育・研究目的で作成されています。
国土地理院地図の利用については、[国土地理院コンテンツ利用規約](https://www.gsi.go.jp/kikakuchousei/kikakuchousei40182.html)に従ってください。

 